/************************************************************************/
/*JOB:      C01J02 - CC_AGREEMENT_ADDED_DATE                            */
/*VERSION:  C01J02V10 - MBNA Migration Update.sql                               */
/*DATE VERSION IMPLEMENTED: 2019/02/24                                  */
/*DEPENDENCIES:                                                         */
/*C01J01                                                                */
/*C01J02                                                                */
/*                                                                      */
/************************************************************************/

.SET ERRORLEVEL (2641,3603) SEVERITY 4, UNKNOWN SEVERITY 8

SET QUERY_BAND = 'ApplicationName=CC_Finance_daily_run;JobID=GRFD043;Worktype=TripleR;Version=LBG;' FOR SESSION;

DATABASE CC_COBRA;

/*STEP 01: INITIAL CHECKS TO SEE IF DAILY LOAD IS SUCCESSFUL*/

SELECT * FROM CC_COBRA.CC_COBRA_LOAD_LOG 
WHERE CURRENT_BUS_DT = (SELECT SOURCE_START_DT FROM CC_COBRA.CC_COBRA_LOAD_START_DT)
AND   GRID_LOAD_ID = 'C01J01';

.IF ACTIVITYCOUNT = 0 THEN .GOTO GRIDERROR;

/*STEP 02: INITIAL CHECKS TO SEE IF THIS PARTICULAR JOB HAS ALREADY RUN SUCCESSFULLY*/
/*IF THERE IS ALREADY DATA IT WILL SKIP THE JOB*/

SELECT * FROM CC_COBRA.CC_COBRA_LOAD_LOG 
WHERE CURRENT_BUS_DT = (SELECT SOURCE_START_DT FROM CC_COBRA.CC_COBRA_LOAD_START_DT)
AND   GRID_LOAD_ID = 'C01J02';

.IF ACTIVITYCOUNT <> 0 THEN .GOTO SKIPJOB;

/*SET THE STATUS START DT/TM*/

UPDATE CC_COBRA.CC_COBRA_LOAD_LOG
FROM CC_COBRA.CC_COBRA_LOAD_STATUS A
SET RUN_ID = A.RUN_ID
,   LOAD_STATUS = 'I'
,   LOAD_START_DT = DATE
,   LOAD_START_TM = TIME
WHERE CC_COBRA.CC_COBRA_LOAD_LOG.GRID_LOAD_ID = 'C01J02'
AND   A.RUN_STATUS = 'I'
;
.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

/*STEP 03: COLLECT ADDED DATES*/

/* 
CREATE SET TABLE CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1 ,NO FALLBACK ,
     NO BEFORE JOURNAL,
     NO AFTER JOURNAL,
     CHECKSUM = DEFAULT,
     DEFAULT MERGEBLOCKRATIO
     (
      ORG_TX CHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('120','170','190','195'),
      V_ORG CHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('120','170','190','195'),
      AGRMNT_ID INTEGER,
      CREDIT_CARD_LOGO_CD SMALLINT COMPRESS(300,100,354,330,340,540,900,320,332,333,344,530,500,355,350,584,304,514,524,505,520,301,334,314,110,338,315,331,380),
      ADDED_DT DATE FORMAT 'YYYY-MM-DD',
      OPENED_DT DATE FORMAT 'YYYY-MM-DD',
      PURGED_DT DATE FORMAT 'YYYY-MM-DD' COMPRESS )
UNIQUE PRIMARY INDEX ( AGRMNT_ID );
*/

DELETE FROM CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1 ALL;

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

INSERT INTO CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1
SELECT
A.ORG_TX
,CASE WHEN V.VERDE_IN IN (1,2) THEN '170' ELSE A.ORG_TX END AS V_ORG
,A.AGRMNT_ID
,CCA.CREDIT_CARD_LOGO_CD
,A.ADDED_DT
,B.OPENED_DT
,B.AGRMNT_EXPIRY_DT
FROM
(
SELECT ORG_TX, AGRMNT_ID, MIN(SOURCE_START_DT) AS ADDED_DT
FROM GDW_VIEWSX.CREDIT_CARD_AGREEMENT A
WHERE ORG_TX <> '170'
GROUP BY 1,2
) A
JOIN CC_COBRA.CC_COBRA_LOAD_START_DT D
ON   A.ADDED_DT<=D.SOURCE_START_DT --ADDED FOR DAY 0 MBNA BUT KEEP FOR FUTURE AS WELL JM
JOIN GDW_VIEWSX.CREDIT_CARD_AGREEMENT CCA
ON   A.AGRMNT_ID = CCA.AGRMNT_ID
AND  CCA.SOURCE_END_DT = '3500/12/31'
JOIN GDW_VIEWSX.AGREEMENT B
--JOIN CC_COBRA.AGREEMENT B
ON   A.AGRMNT_ID = B.AGRMNT_ID
AND  B.SOURCE_END_DT = '3500/12/31'
LEFT JOIN CC_COBRA.CC_VERDE_FLAG_DAILY V
ON   A.AGRMNT_ID = V.AGRMNT_ID
AND  V.SOURCE_END_DT = '3500/12/31'
;


.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

COLLECT STATS ON CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1 INDEX(AGRMNT_ID);

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

/*INSERT INTO MAIN TABLE*/

/*
CREATE SET TABLE CC_COBRA.CC_AGREEMENT_ADDED_DATE ,NO FALLBACK ,
     NO BEFORE JOURNAL,
     NO AFTER JOURNAL,
     CHECKSUM = DEFAULT,
     DEFAULT MERGEBLOCKRATIO
     (
      ORG_TX CHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('120','190','195'),
      V_ORG CHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('120','190','195'),
      AGRMNT_ID INTEGER,
      ORIGNL_AGRMNT_ID INTEGER COMPRESS 428716042 ,
      AGRMNT_RLTNSP_SEQUNC_NO INTEGER COMPRESS (0 ,1 ,2 ),
      CREDIT_CARD_LOGO_CD SMALLINT COMPRESS(300,100,354,330,340,540,900,320,332,333,344,530,500,355,350,584,304,514,524,505,520,301,334,314,110,338,315,331,380),
      ADDED_DT DATE FORMAT 'YYYY-MM-DD' COMPRESS (DATE '2004-01-31',DATE '2002-04-30',DATE '2003-04-30',DATE '2001-07-31',DATE '2001-02-28',DATE '2002-07-31',DATE '2003-12-31',DATE '2002-02-28',DATE '2003-07-31',DATE '2003-02-24',DATE '2003-02-28',DATE '2001-10-31',DATE '2004-02-29',DATE '2002-10-31',DATE '1990-02-01',DATE '2003-10-19',DATE '2002-05-31',DATE '2003-05-31',DATE '2001-08-31',DATE '2005-10-24',DATE '2001-03-31',DATE '2002-03-31',DATE '2001-11-30',DATE '2003-03-31',DATE '2001-06-30',DATE '2002-11-30',DATE '2004-03-31',DATE '2002-01-31',DATE '2003-06-30',DATE '2003-01-31',DATE '2004-06-30'),
      ORIGNL_ADDED_DT DATE FORMAT 'YYYY-MM-DD' COMPRESS (DATE '2004-01-31',DATE '2002-04-30',DATE '2003-04-30',DATE '2001-07-31',DATE '2002-07-31',DATE '2003-12-31',DATE '2002-02-28',DATE '2003-07-31',DATE '2003-02-28',DATE '2001-10-31',DATE '2001-05-31',DATE '2004-02-29',DATE '2002-10-31',DATE '1990-02-01',DATE '2002-05-31',DATE '1999-03-31',DATE '2004-10-31',DATE '2001-08-31',DATE '2001-03-31',DATE '1995-12-01',DATE '2002-03-31',DATE '2001-11-30',DATE '2003-03-31',DATE '2001-06-30',DATE '2004-03-31',DATE '2002-01-31',DATE '2003-06-30',DATE '2004-11-30',DATE '2001-09-30',DATE '2003-01-31',DATE '2004-06-30'),
      OPENED_DT DATE FORMAT 'YYYY-MM-DD', 
      PURGED_DT DATE FORMAT 'YYYY-MM-DD' COMPRESS (DATE '2006-11-30',DATE '2008-03-31',DATE '2001-12-31',DATE '2000-02-28',DATE '2007-06-30',DATE '2004-04-30',DATE '1999-10-31',DATE '2008-01-31',DATE '2007-09-30',DATE '2009-01-31',DATE '2001-10-31',DATE '2005-12-31',DATE '2008-09-30',DATE '2008-04-30',DATE '2007-12-31',DATE '2007-07-31',DATE '2008-12-31',DATE '2008-07-31',DATE '2005-05-31',DATE '1999-06-30',DATE '2009-02-28',DATE '2000-01-31',DATE '2007-05-31',DATE '2008-10-31',DATE '1999-09-30',DATE '1999-04-30',DATE '2007-08-31',DATE '2001-09-30',DATE '2007-03-31',DATE '1999-12-31',DATE '2008-08-31'),
      AGRMNT_SELLNG_SORT_CD CHAR(8) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('        ','115219  ','119645  ','301553  ','301995  ','302500  ','303332  ','306284  ','306289  ','306347  ','306418  ','306442  ','306444  ','306457  ','306522  ','306549  ','306560  ','306585  ','306676  ','306776  ','307497  ','307882  ','308037  ','308055  ','308426  ','308458  ','308467  ','308479  ','309021  ','309028  ','309042  ','309054  ','309066  ','309187  ','309192  ','309197  ','309233  ','309238  ','309259  ','309279  ','309286  ','309293  ','309348  ','309360  ','309371  ','309374  ','309376  ','309428  ','309443  ','309455  ','309470  ','309477  ','309493  ','309497  ','309537  ','309546  ','309599  ','309609  ','309612  ','309617  ','309618  ','309635  ','309638  ','309668  ','309673  ','309682  ','309691  ','309696  ','309697  ','309717  ','309741  ','309744  ','309762  ','309778  ','309784  ','309829  ','309834  ','309836  ','309845  ','309875  ','309893  ','309906  ','309921  ','309932  ','30995   ','309951  '),
      MAC_CD CHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('9999999999999999    ','9999999999999D99    ','9999999999999E99    ','9999999999999F99    ','AAW                 ','AAY                 ','ABA                 ','ABC                 ','ABG                 ','ABX                 ','ABZ                 ','ACQ                 ','ACR                 ','AZGBNBBRIBRNM000    ','AZGBNSBRIBRNM000    ','AZMBNBBRIBRNM000    ','AZVBNBBRIBRNV000    ','BZGBNBBRIBRNM000    ','BZGBNSBRIBRNM000    ','BZMBNBBRIBRNM000    ','BZMBNBVAIBRNM000    ','BZPBNBPYIBRNV000    ','BZPBNBPZIBRNV000    ','BZPBTBPYIBRNV000    ','BZPBTBPZIBRNV000    ','BZTBNBBRIBRNV000    ','BZTBNSBRIBRNV000    ','BZVBNBBRIBRNV000    ','BZVBNBVAIBRNV000    ','CEGBNQVBIPINM000    ','DEXBNBNUGNANA000    ','DEXBTBNUGNANA000    ','DEXBTBNUGNANA0AZ    ','DZPBNJBRIBRNA000    ','DZXBNBNUGNANA000    ','DZXBNBNUGNANA0AZ    ','DZXBTBNUGNANA000    ','DZXPNPNUGFZNA000    ','DZXPNPNUGFZNA0AZ    ','EAA                 ','EAJ                 ','FBDSTZAAGDF
        ','JSW                 ','JTY                 ','JVG                 ','JVL                 ','JWN                 ','JZEBNZAAIQFZM0LZ    ','JZEBNZAAIREZM0ZZ    ','JZEBNZABIREZM0ZZ    ','JZPBNZAAIJSZM0KZ    ','JZSBNZAAIPDZM0BZ    ','KGE                 ','KGF                 ','KGG                 ','KGPINZAAITUZM0YG    ','KGU                 ','KGV                 ','KGW                 ','KGX                 ','KHF                 ','KHG                 ','KHH                 ','KIY                 ','KIZ                 ','KJA                 ','XAB                 ','XAC                 ','XAD                 ','XCA                 ','XCB                 ','YAB                 ','YAD                 ','YAE                 ','YAF                 ','YAG                 ','ZAA                 ','ZAC                 ','ZAF                 ','ZAI                 ','ZAK                 ','ZAL                 ','ZAM                 ','ZAO                 ','ZAR                 '),
      AGRMNT_SELLNG_CHANNL_CD VARCHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('GP1843','GP1800','GP1829','GP1801','GP1805','GP1816','GP1791'),
      ORIGNL_AGRMNT_SELLNG_SORT_CD CHAR(8) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('115219  ','301995  ','306289  ','307882  ','777505  ','779313  ','805121  '),
      ORIGNL_MAC_CD CHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('9999999999999999    ','AAW                 ','AAY                 ','ABA                 ','ABC                 ','ABG                 ','ABX                 ','ABY                 ','ABZ                 ','ACQ                 ','ACR                 ','AZGBNBBRIBRNM000    ','AZGBNSBRIBRNM000    ','AZMBNBBRIBRNM000    ','AZVBNBBRIBRNV000    ','BZGBNBBRIBRNM000    ','BZGBNSBRIBRNM000    ','BZMBNBBRIBRNM000    ','BZMBNBVAIBRNM000    ','BZPBNBPYIBRNV000    ','BZPBNBPZIBRNV000    ','BZTBNBBRIBRNV000    ','BZTBNSBRIBRNV000    ','BZVBNBBRIBRNV000    ','BZVBNBVAIBRNV000    ','BZVBNGBRGBRNV000    ','CEGBNQVBIPINM000    ','DEXBNBNUGNANA000    ','DEXBNBNUGNANA0AZ    ','DEXBTBNUGNANA000    ','DEXBTBNUGNANA0AZ    ','DZPBNJBRIBRNA000    ','DZXBNBNUGNANA000    ','DZXBNBNUGNANA0AZ    ','DZXPNPNUGFXNA000    ','DZXPNPNUGFZNA000    ','DZXPNPNUGFZNA0AZ    ','EAA                 ','EAJ                 ','FHAINZACIAWZA000    ','FHEB
               ','FHEBNZAIIZZZA0AZ    ','JVL                 ','JWN                 ','JZEBNZAAIQFZM0LZ    ','JZEBNZAAIREZM0ZZ    ','JZEBNZABIREZM0ZZ    ','JZGBNZAAIJRZM0KZ    ','JZPBNZAAIJSZM0KZ    ','JZSBNZAAIPDZM0BZ    ','KBNINZAAITQZBBRZ    ','KGE                 ','KGF                 ','KGG                 ','KGPINZAAITUZM0YG    ','KGU                 ','KGV                 ','KGW                 ','KGX                 ','KHF                 ','KHG                 ','KHH                 ','KIY                 ','KIZ                 ','KJA                 ','XAA                 ','XAB                 ','XAC                 ','XAD                 ','XCA                 ','XCB                 ','YAB                 ','YAD                 ','YAE                 ','YAF                 ','YAG                 ','ZAA                 ','ZAC                 ','ZAF                 ','ZAI                 ','ZAK                 ','ZAL                 ','ZAM                 ','ZAO                 ','ZAR                 '),
      ORIGNL_AGRMNT_SELLNG_CHANNL_CD VARCHAR(12) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('GP1843','GP1800','GP1829','GP1801','GP1805','GP1816','GP1791'))
UNIQUE PRIMARY INDEX ( AGRMNT_ID )
INDEX ( ORIGNL_AGRMNT_ID );
*/

DELETE FROM CC_COBRA.CC_AGREEMENT_ADDED_DATE ALL;

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

INSERT INTO CC_COBRA.CC_AGREEMENT_ADDED_DATE
SELECT B2.ORG_TX
     , B2.V_ORG
     , T1.AGRMNT_ID
     , T1.ORIGNL_AGRMNT_ID
     , T1.AGRMNT_RLTNSP_SEQUNC_NO
     , B2.CREDIT_CARD_LOGO_CD  --06/01/2017 - changed this to B2 - JM
     , COALESCE(M.ACC_BUILD_DT,B2.ADDED_DT)
     , COALESCE(M.ACC_OPEN_DT,B.ADDED_DT)
     , B2.OPENED_DT --12/02/2018 - changed this to B2 - JM
     , B2.PURGED_DT
     , AST.AGRMNT_SELLNG_SORT_CD
     , AST.MAC_CD
     , AST.AGRMNT_SELLNG_CHANNL_CD
     --SET ORIGNL TO CURRENT ONE - WILL BE UPDATED IN LAST UPDATE STATEMENT FOR TRADES
     , AST.AGRMNT_SELLNG_SORT_CD
     , AST.MAC_CD
     , AST.AGRMNT_SELLNG_CHANNL_CD

FROM  GDW_VIEWSX.AGREEMENT_RELATIONSHIP T1 
JOIN  CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1 B
ON    T1.ORIGNL_AGRMNT_ID = B.AGRMNT_ID
JOIN  CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1 B2
ON    T1.AGRMNT_ID = B2.AGRMNT_ID
LEFT JOIN GRIDX_DV_RETAIL.AGREEMENT_STATIC AST
ON    T1.AGRMNT_ID = AST.AGRMNT_ID
/*LEFT JOIN CC_COBRA.CC_HBOS_MIGRATION_ACCOUNTS M --Replaced on 24/02/2019 - MBNA migration		*/
LEFT JOIN CC_COBRA_VIEWS.VW_CC_MIGRATION_ACCOUNTS M
ON    T1.AGRMNT_ID = M.AGRMNT_ID
WHERE AGRMNT_RLTNSP_SEQUNC_NO IS NOT NULL
UNION  
SELECT B.ORG_TX
     , B.V_ORG
     , T1.ORIGNL_AGRMNT_ID AS AGRMNT_ID
     , T1.ORIGNL_AGRMNT_ID 
     , 0 AS AGRMNT_RLTNSP_SEQUNC_NO
     , B.CREDIT_CARD_LOGO_CD  --THIS STAYS AS B BECAUSE IT IS THE FIRST ONE IN THE CHAIN.
     , COALESCE(M.ACC_BUILD_DT,B.ADDED_DT)
     , COALESCE(M.ACC_OPEN_DT,B.ADDED_DT)
     , B.OPENED_DT
     , B.PURGED_DT
     , AST.AGRMNT_SELLNG_SORT_CD
     , AST.MAC_CD
     , AST.AGRMNT_SELLNG_CHANNL_CD
     --SET ORIGNL TO CURRENT ONE - WILL BE UPDATED IN LAST UPDATE STATEMENT FOR TRADES
     , AST.AGRMNT_SELLNG_SORT_CD
     , AST.MAC_CD
     , AST.AGRMNT_SELLNG_CHANNL_CD
FROM GDW_VIEWSX.AGREEMENT_RELATIONSHIP T1
JOIN  CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1 B
ON    T1.ORIGNL_AGRMNT_ID = B.AGRMNT_ID
LEFT JOIN GRIDX_DV_RETAIL.AGREEMENT_STATIC AST
ON    T1.ORIGNL_AGRMNT_ID = AST.AGRMNT_ID
/*LEFT JOIN CC_COBRA.CC_HBOS_MIGRATION_ACCOUNTS M --Replaced on 24/02/2019 - MBNA migration        */
LEFT JOIN CC_COBRA_VIEWS.VW_CC_MIGRATION_ACCOUNTS M 
ON    T1.ORIGNL_AGRMNT_ID = M.AGRMNT_ID
WHERE  AGRMNT_RLTNSP_SEQUNC_NO = 1
;

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

/*STEP 02: COLLECT ORIGNL_AGRMNT_ID VINTAGE - COLLECT ONES THAT DON'T EXIST IN THE RELATIONSHIP TABLE*/    

INSERT INTO  CC_COBRA.CC_AGREEMENT_ADDED_DATE
SELECT B.ORG_TX
   	  ,B.V_ORG
      ,A.AGRMNT_ID
      ,A.AGRMNT_ID
      ,0
      ,B.CREDIT_CARD_LOGO_CD
      ,COALESCE(M.ACC_BUILD_DT,B.ADDED_DT)
      ,COALESCE(M.ACC_OPEN_DT,B.ADDED_DT)
      ,B.OPENED_DT
      ,B.PURGED_DT
      ,AST.AGRMNT_SELLNG_SORT_CD
      ,AST.MAC_CD
      ,AST.AGRMNT_SELLNG_CHANNL_CD
      --SET ORIGNL TO CURRENT ONE - WILL BE UPDATED IN LAST UPDATE STATEMENT FOR TRADES
      ,AST.AGRMNT_SELLNG_SORT_CD
      ,AST.MAC_CD
      ,AST.AGRMNT_SELLNG_CHANNL_CD
FROM  GDW_VIEWSX.CREDIT_CARD_AGREEMENT A
JOIN  CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1 B
ON    A.AGRMNT_ID = B.AGRMNT_ID
LEFT JOIN GRIDX_DV_RETAIL.AGREEMENT_STATIC AST
ON    A.AGRMNT_ID = AST.AGRMNT_ID
/*LEFT JOIN CC_COBRA.CC_HBOS_MIGRATION_ACCOUNTS M --Replaced on 24/02/2019 - MBNA migration        */
LEFT JOIN CC_COBRA_VIEWS.VW_CC_MIGRATION_ACCOUNTS M
ON     A.AGRMNT_ID = M.AGRMNT_ID
WHERE NOT EXISTS (SELECT NULL
                  FROM CC_COBRA.CC_AGREEMENT_ADDED_DATE B
                  WHERE A.AGRMNT_ID = B.AGRMNT_ID)
AND A.SOURCE_END_DT = '3500/12/31' 
;

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

COLLECT STATS ON CC_COBRA.CC_AGREEMENT_ADDED_DATE INDEX(ORIGNL_AGRMNT_ID);
.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;
COLLECT STATS ON CC_COBRA.CC_AGREEMENT_ADDED_DATE INDEX(AGRMNT_ID);
.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

/*PICKS UP DETAILS FOR ACCOUNTS NOT YET IN AGREEMENT_STATIC*/


UPDATE CC_COBRA.CC_AGREEMENT_ADDED_DATE
FROM (
SELECT   CAK.AGRMNT_ID
        ,AOM.SELLNG_BRANCH_SORT_CD  AS AGRMNT_SELLNG_SORT_CD
        ,COALESCE(WK_MAC.MAC_CD,'9999999999999999') AS MAC_CD
        ,CHC.CHANNL_CD AS AGRMNT_SELLNG_CHANNL_CD

FROM     (SELECT * FROM GDW_VIEWSX.CREDIT_CARD_AGREEMENT A
          WHERE NOT EXISTS (SELECT 'Y'
                            FROM  GRIDX_DV_RETAIL.AGREEMENT_STATIC B
                            WHERE A.AGRMNT_ID = B.AGRMNT_ID)
          AND A.SOURCE_END_DT = '3500/12/31'
                            ) CAK

LEFT OUTER JOIN GDW_VIEWSX.AGREEMENT_OFFER_MANAGER AOM
ON       CAK.AGRMNT_ID   = AOM.AGRMNT_ID
AND      AOM.OFFER_ID_TX IN ('NEWACC','005Z0NEW  ')
AND      AOM.SOURCE_END_DT = '3500/12/31'

LEFT OUTER JOIN
        (SELECT   ACM.AGRMNT_ID
                 ,ACM.MAC_CD
                 ,ACM.NEW_MAC_TYPE_IN
                 ,ROW_NUMBER() OVER    (PARTITION BY ACM.AGRMNT_ID
                               ORDER BY ACM.SOURCE_START_DT)
                                                    AS MAC_SEQ
         FROM    GDW_VIEWSX.AGREEMENT_CC_MAC ACM
         INNER JOIN GDW_VIEWSX.CREDIT_CARD_AGREEMENT CAK
         ON    CAK.AGRMNT_ID = ACM.AGRMNT_ID
         AND   CAK.SOURCE_END_DT = '3500/12/31'
         WHERE NEW_MAC_TYPE_IN = 'Y') AS WK_MAC
ON       CAK.AGRMNT_ID = WK_MAC.AGRMNT_ID
AND      WK_MAC.MAC_SEQ = 1
/*NEW CODE: 2013/02/15*/
LEFT OUTER JOIN
 (
 SEL CHANNL_CD, SORT_CD
 FROM GDW_VIEWS.OU_STRUCTURE_SORTCODE_GL
 GROUP BY 1,2
 ) CHC

ON AOM.SELLNG_BRANCH_SORT_CD = CAST(CHC.SORT_CD AS CHAR(6))

/* OLD CODE
LEFT OUTER JOIN
 (
SEL CNL_GRP_CD ,   INP_SRT_CD 
FROM DQVIEWSP.CHANNEL_HIERARCHY_CURR                
WHERE REC_EFC_TO_DT = '3500/12/31'                  
AND  (ABS(INP_SRT_CD) , INP_SRT_CD ) IN 
 (SEL  ABS(INP_SRT_CD ) , MAX(INP_SRT_CD)  
 FROM   DQVIEWSP.CHANNEL_HIERARCHY_CURR  
 GROUP BY 1
 )
 GROUP BY 1,2
 ) CHC

ON AOM.SELLNG_BRANCH_SORT_CD = CAST (ABS(CHC.INP_SRT_CD) AS CHAR(6))
*/

) T1
SET AGRMNT_SELLNG_SORT_CD = T1.AGRMNT_SELLNG_SORT_CD
   ,MAC_CD = T1.MAC_CD
   ,AGRMNT_SELLNG_CHANNL_CD = T1.AGRMNT_SELLNG_CHANNL_CD
--SET ORIGNL TO CURRENT ONE - WILL BE UPDATED IN NEXT UPDATE STATEMENT FOR TRADES
   ,ORIGNL_AGRMNT_SELLNG_SORT_CD = T1.AGRMNT_SELLNG_SORT_CD
   ,ORIGNL_MAC_CD = T1.MAC_CD
   ,ORIGNL_AGRMNT_SELLNG_CHANNL_CD = T1.AGRMNT_SELLNG_CHANNL_CD
WHERE CC_COBRA.CC_AGREEMENT_ADDED_DATE.AGRMNT_ID = T1.AGRMNT_ID
;

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

/*UPDATES TRADES WITH ORIGNL_AGRMNT_IDS CHANNEL DATA ITEMS*/

UPDATE CC_COBRA.CC_AGREEMENT_ADDED_DATE 
FROM (
SELECT A.AGRMNT_ID    
       ,B.ORIGNL_AGRMNT_SELLNG_SORT_CD 
       ,B.ORIGNL_MAC_CD 
       ,B.ORIGNL_AGRMNT_SELLNG_CHANNL_CD 
FROM CC_COBRA.CC_AGREEMENT_ADDED_DATE A
JOIN CC_COBRA.CC_AGREEMENT_ADDED_DATE B
ON   A.ORIGNL_AGRMNT_ID = B.ORIGNL_AGRMNT_ID
-- ONLY FIRST AGRMNT_IDS FROM B TABLE
AND  B.ORIGNL_AGRMNT_ID = B.AGRMNT_ID
-- ONLY TRADES FROM A TABLE
AND  A.ORIGNL_AGRMNT_ID <> A.AGRMNT_ID ) T1
SET ORIGNL_AGRMNT_SELLNG_SORT_CD = T1.ORIGNL_AGRMNT_SELLNG_SORT_CD
   ,ORIGNL_MAC_CD = T1.ORIGNL_MAC_CD
   ,ORIGNL_AGRMNT_SELLNG_CHANNL_CD = T1.ORIGNL_AGRMNT_SELLNG_CHANNL_CD
WHERE CC_COBRA.CC_AGREEMENT_ADDED_DATE.AGRMNT_ID = T1.AGRMNT_ID;

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

DELETE FROM CC_COBRA.WK_CC_AGREEMENT_ADDED_DT_T1 ALL;

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

/*UPDATE THE LOAD LOG TO THE CURRENT DATE TO INDICATE SUCCESSFUL PROCESSING*/

UPDATE CC_COBRA.CC_COBRA_LOAD_LOG
SET  CURRENT_LOAD_DT = (SELECT START_DT FROM CC_COBRA.CC_COBRA_LOAD_START_DT)
   , CURRENT_BUS_DT = (SELECT SOURCE_START_DT FROM CC_COBRA.CC_COBRA_LOAD_START_DT)
   , UPDATE_DT = DATE
   , UPDATE_TM = TIME
   , LOAD_STATUS = 'C'
WHERE GRID_LOAD_ID = 'C01J02'
;

.IF ERRORCODE <> 0 THEN .GOTO FOUNDERROR;

SELECT GRID_LOAD_ID, CURRENT_BUS_DT, CURRENT_LOAD_DT 
FROM CC_COBRA.CC_COBRA_LOAD_LOG WHERE GRID_LOAD_ID = 'C01J02';


.QUIT;

.LABEL SKIPJOB;

.QUIT;

.LABEL FOUNDERROR;

UPDATE CC_COBRA.CC_COBRA_LOAD_LOG
SET  LOAD_STATUS = 'F'
WHERE GRID_LOAD_ID = 'C01J02'
;

.QUIT 0;

.LABEL GRIDERROR;

.QUIT;



